# MBTI V2 ???????

??????????????????????????????`g:\mbti\mbti-v2`?

## ?????

??? `lizehao.asia` ??? Cloudflare Pages ?? `mbti-test`????? `npx wrangler pages deploy dist --project-name mbti-test` ????????Git ?????????????

## ????????

```bash
cd mbti-v2
npm run build
npx wrangler pages deploy dist --project-name mbti-test --commit-dirty=true
```

## ??????????????

```bash
npx wrangler pages deploy dist --project-name mbti-test --branch preview
```

???`--branch preview` ??? `preview.*.pages.dev`??????????

## Git ?????????? push?

```bash
git add -A
git commit -m "??"
git push
```

???Git push ?????????????????????? `wrangler pages deploy`?

## Cloudflare ??

### Pages ?????Dashboard -> Pages -> mbti-test -> Settings -> Environment variables?

| ??? | ?? |
| --- | --- |
| ZY_PID | ????? ID |
| ZY_PRIVATE_KEY | ??????RSA? |
| ZY_PUBLIC_KEY | ??????????? |
| ZY_API_BASE | ??? API ????? `http://pay.zy520888.com` |
| ADMIN_KEY | ??????????????? |

### ????

- D1????????????????? `MBTI_DB`????? `mbti`?
- KV??????????????? `MBTI_USERS`????? ID `0272b12877264d808bec5fbee5f4db93`?

????????????????????????? D1?KV ???????????????????

## ????

### ????????D1????

```bash
npx wrangler d1 execute mbti --remote --command "INSERT INTO users (phone, pin, credits, created_at, updated_at) VALUES ('18947108008','',100000, strftime('%s','now')*1000, strftime('%s','now')*1000) ON CONFLICT(phone) DO UPDATE SET credits = users.credits + 100000, updated_at = excluded.updated_at;"
```

### ????????Admin API????

```powershell
Invoke-RestMethod -Uri "https://lizehao.asia/api/admin/add-credits" -Method POST -ContentType "application/json" -Body '{"phone":"???","credits":????,"adminKey":"???????"}'
```

### ??????

```powershell
Invoke-RestMethod -Uri "https://lizehao.asia/api/user/query?phone=???&pin=??" -Method GET
```

## ????

```
mbti-v2/
  src/                    # ????
    pages/                # ????
      Home.tsx            # ??
      Test.tsx            # ???
      Payment.tsx         # ???
      Result.tsx          # ???
      History.tsx         # ????
      Recharge.tsx        # ???
    components/           # ????
    data/                 # ????
  functions/              # Cloudflare Functions (?? API)
    api/
      zy/                 # ????
        create-order.js
        notify.js
        query-order.js
      user/               # ????
        save.js
        query.js
        use-credit.js
      admin/              # ????
        add-credits.js
  dist/                   # ????
  public/                 # ????
```

## ????????

1. ?????? -> `create-order.js` ????
2. ????/????
3. ???? -> ????? `notify.js` -> ???????D1?
4. ???? `query-order.js` ??????
5. ??????? -> ???? -> ?????

## ????

| ?? | ?? | ?? |
| --- | --- | --- |
| ?? | ?1 | 3 ? |
| RECHARGE_3 | ?1 | 3 ? |
| RECHARGE_10 | ?3 | 10 ? |
| RECHARGE_30 | ?8 | 30 ? |

## ????????????

1. ???????????????????? Markdown/TS/JSON ??????? UTF-8?? BOM?????? UTF-8 ?????
2. `wrangler.toml` ??????????????????? `wrangler pages deploy`?
3. ????? Pages ??????? GitHub Actions??? Git ????????
4. ?????????????? D1?KV ???????????????
5. ????????? `--branch preview`??????????

## Git ??????

?????????

```bash
git config --global http.proxy socks5://127.0.0.1:10808
git config --global https.proxy socks5://127.0.0.1:10808
```

GitHub ???`lizehao-1/mbti-v2`

## ??

- ????`lizehao.asia`?Cloudflare Pages ?? `mbti-test` ?????
- Pages ???`mbti-test-a06.pages.dev`
